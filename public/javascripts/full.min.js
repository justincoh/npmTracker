"use strict";var app=angular.module("npmTracker",["ngResource"]);app.directive("summaryChart",function(data){return{restrict:"E",templateUrl:"templates/summaryChart.html",link:function(scope,element,attrs){scope.$watch("packageData.length",function(){"undefined"!=typeof scope.packageData&&"undefined"!=typeof scope.packageData[0]&&(scope.buildChart(),d3.select(".spinner").style("display","none"))}),scope.buildChart=function(){function buildTooltip(){var scaleData=d3.select(this),packageName=this.classList[0],displayName=packageName.slice(0,1).toUpperCase()+packageName.slice(1),date=x.invert(scaleData.attr("cx")).toLocaleDateString(),downloads=y.invert(scaleData.attr("cy")).toFixed(0),downloads=downloads.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,"),template=displayName+"<br>"+date+"<br>"+downloads+" Downloads";tooltip.style("left",d3.event.pageX-40+"px").style("top",d3.event.pageY-75+"px"),tooltip.html([template]),tooltip.style("opacity",1).style("background",function(d){return color(packageName)})}function draw(){var domain=x.domain();domain=domain[1]-domain[0];var msPerDay=864e5,diff=domain/msPerDay;if(x.domain()[0]<startTime){var k=zoom.translate()[0]-x(startTime)+x.range()[0];zoom.translate([k,0])}else if(x.domain()[1]>endTime){var k=zoom.translate()[0]-x(endTime)+x.range()[1];zoom.translate([k,0])}svg.select("g.x.axis").call(xAxis),svg.selectAll("path.line").attr("d",function(d){return line(d.downloads)}),svg.selectAll(".datapoints").attr("cx",function(d){return x(d.date)}).attr("cy",function(d){return y(d.downloads)}).style("opacity",function(d){return x(d.date)<=0?0:void 0}).transition().attr("r",function(d){return diff>75?"3px":diff>40?"4px":diff>20?"5px":"7px"})}d3.select("svg").remove();var data=scope.packageData,color=d3.scale.category10(),margin={top:20,right:20,bottom:30,left:90},width=1e3-margin.left-margin.right,height=500-margin.top-margin.bottom,startTime=new Date("2015-06-01"),endTime=new Date,x=d3.time.scale().domain([startTime,endTime]).range([0,width]),y=d3.scale.linear().range([height,0]),getMax=function(arr){var max=0;return arr.forEach(function(npmPackage){npmPackage.downloads.forEach(function(day){day.downloads>max&&(max=day.downloads)})}),max},downloadMax=getMax(data),getMin=function(arr){var min=downloadMax;return arr.forEach(function(npmPackage){npmPackage.downloads.forEach(function(day){day.downloads<min&&(min=day.downloads)})}),min},downloadMin=getMin(data);y.domain([.75*downloadMin,1.1*downloadMax]);var line=d3.svg.line().x(function(d){return x(d.date)}).y(function(d){return y(d.downloads)}),zoom=d3.behavior.zoom().x(x).scaleExtent([1,10]).on("zoom",draw),svg=d3.select("#chart-container").append("svg").attr("width","100%").attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")").call(zoom);svg.append("rect").attr("class","background").attr("width",width).attr("height",height).style("opacity",0),svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",2*width).attr("height",height);var xAxis=d3.svg.axis().scale(x).orient("bottom");svg.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").attr("width","100%").call(xAxis),svg.append("g").attr("class","y axis").call(d3.svg.axis().scale(y).orient("left")).append("text").attr("transform","rotate(-90)").attr("y",-85).attr("x",-175).attr("dy",".71em").style("text-anchor","end").text("Downloads"),svg.selectAll(".npmPackage").data(data).enter().append("g").attr("class",function(d){return d.name+" package"});var packages=svg.selectAll(".package");packages.append("path").attr("class",function(d){return d.name+" line"}).attr("clip-path",function(d){return"url(#clip)"}).attr("d",function(d){return line(d.downloads)}).style("stroke",function(d){return color(d.name)}),packages.each(function(parentData){var thisPackage=d3.select(this);thisPackage.selectAll(".datapoints").data(parentData.downloads).enter().append("circle").attr("class",function(d){return parentData.name+" datapoints"}).attr("cx",function(d){return x(d.date)}).attr("cy",function(d){return y(d.downloads)}).attr("r","3px").attr("fill",function(d){return color(parentData.name)}).on("mouseover",function(d){buildTooltip.call(this)}).on("mousemove",function(){buildTooltip.call(this)}).on("mouseout",function(){tooltip.transition().duration(500).style("opacity",0).each("end",removeTooltip)})});var tooltip=d3.select("#tooltip"),removeTooltip=function(){d3.select(this).style("left","0px").style("top","0px")},legendRectSize=18,legendSpacing=4,legend=svg.selectAll(".legend").data(color.domain()).enter().append("g").attr("class","legend").attr("transform",function(d,i){var height=legendRectSize+legendSpacing,offset=height*color.domain().length/2,vert=i*height-offset;return"translate("+1.05*width+","+(vert+200)+")"});legend.append("rect").attr("width",legendRectSize).attr("height",legendRectSize).style("fill",color).style("stroke",color),legend.append("text").attr("x",legendRectSize+legendSpacing).attr("y",legendRectSize-legendSpacing).text(function(d){return d[0].toUpperCase()+d.slice(1)}),draw()}}}}),app.controller("MainCtrl",function($scope,data,populate){var namesOnScope=[],namesInTable=[];populate.query(function(res,err){data.setData(res),$scope.allData=data.getData(),$scope.allData.data.forEach(function(el){namesOnScope.push(el.name)}),$scope.packageData=$scope.allData.data.filter(function(el){return"lodash"===el.name||"underscore"===el.name}),$scope.packageData.forEach(function(el){namesInTable.push(el.name)})}),$scope.today=new Date,$scope.todayString=$scope.today.toISOString().slice(0,10),$scope.startDate=new Date("2015-06-01"),$scope.startDateString=$scope.startDate.toISOString().slice(0,10),$scope.getNewData=function(){return-1!==namesOnScope.indexOf($scope.packageName.toLowerCase())?$scope.errorMessage=$scope.packageName+" data is already here!":void data.resource.query({name:$scope.packageName,startDate:$scope.startDateString,endDate:$scope.todayString},function(res,err){return 0===res[0]?$scope.errorMessage="No data found for package: "+$scope.packageName:void data.addToData(res[0])})},$scope.removePackage=function(packageName){1===$scope.packageData.length&&(d3.selectAll("path").remove(),d3.selectAll(".datapoints").remove(),d3.selectAll(".legend").remove()),$scope.packageData=$scope.packageData.filter(function(el){return el.name!==packageName}),namesInTable=namesInTable.filter(function(name){return name!==packageName})},$scope.addPackage=function(packageName){if(-1!==namesInTable.indexOf(packageName))return $scope.lineHighlight(packageName);var packageToAdd=$scope.allData.data.filter(function(el){return el.name===packageName});packageToAdd=packageToAdd[0],$scope.packageData.push(packageToAdd),namesInTable.push(packageToAdd.name)},$scope.isActive=function(packageName){return-1!==namesInTable.indexOf(packageName)?"active":""},$scope.lineHighlight=function(packageName){d3.selectAll(".line").transition().duration(500).ease("bounce").style("stroke-width","2px"),d3.select("."+packageName+" .line").transition().duration(1e3).ease("bounce").style("stroke-width","8px")}}),app.filter("upcase",function(){return function(input){return input?input[0].toUpperCase()+input.slice(1).toLowerCase():void 0}}),app.factory("populate",function($resource){return $resource("/populate")}),app.factory("data",function($resource,$rootScope){var data={};return{getData:function(){return data},setData:function(args){var names=[];args.forEach(function(npmPackage){names.push(npmPackage.name),npmPackage.downloads.forEach(function(download){download.date=new Date(download.date)})}),data.data=args,data.names=names},addToData:function(npmPackage){npmPackage.downloads.forEach(function(download){download.date=new Date(download.date)}),data.data.push(npmPackage)},resource:$resource("/data")}}),app.directive("summaryTable",function(data){return{restrict:"E",templateUrl:"templates/summaryTable.html",link:function(scope,element,attrs){scope.rowHandler=function(e){var thisPackage=this.data.name;-1!==e.target.className.split(" ").indexOf("remove")?scope.removePackage(thisPackage):scope.lineHighlight(thisPackage)}}}});